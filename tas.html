<!DOCTYPE html>
<html lang="id">

<head>
    <link rel="icon" href="images/logo1.jpeg" type="image/jpeg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tas Belanja - PLAHRAGA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">

</head>

<body>
    <!-- Container untuk video background -->
    <div class="background-video-container">
        <video autoplay muted loop id="myVideo">
            <source src="video/footage.mp4" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
    </div>
    <!-- Header dengan Navigasi -->
    <header>
        <nav class="navbar">
            <div class="nav-container">
                <a href="index.html" class="nav-logo">
                    <div class="logo-container">
                        <img src="images/logo.png" alt="PLAHRAGA Logo" id="logo1" class="logo-image active"
                            style="height: 40px;">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Shopee.svg/960px-Shopee.svg.png"
                            alt="Shopee Logo" id="logo2" class="logo-image" style="height: 40px;">
                    </div>
                </a>
                <!-- Semua elemen navbar lainnya dihapus sesuai permintaan -->
            </div>
        </nav>
    </header>

    <!-- Konten Halaman Tas -->
    <main class="container bag-page loading-content">
        <a href="javascript:history.back()"
            style="display: inline-block; margin-bottom: 1.5rem; color: white; text-decoration: none; background-color: rgba(255, 255, 255, 0.2); padding: 8px 16px; border-radius: 8px; transition: background-color 0.3s;"
            onmouseover="this.style.backgroundColor='rgba(255, 255, 255, 0.3)'"
            onmouseout="this.style.backgroundColor='rgba(255, 255, 255, 0.2)'">&larr; Kembali</a>
        <h1 class="section-title">Tas Belanja Anda</h1>
        <!-- Loader akan ditampilkan di sini saat memuat -->
        <div id="bag-loader" class="loading-indicator" style="display: none; color: white;">
            <i class="fas fa-spinner fa-spin"></i>
            <p style="margin-top: 1rem; font-size: 1.2rem;">Memuat produk...</p>
        </div>
        <!-- Kontainer untuk item tas -->
        <div id="bag-items-container"></div>
    </main>



    <script src="js/script.js"></script>
    <script type="module">
        import { db, auth } from './js/firebase-config.js';
        import { collection, getDocs, doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"; // getDoc diimpor
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        const bagItemsContainer = document.getElementById('bag-items-container');
        const bagLoader = document.getElementById('bag-loader');
        const mainContent = document.querySelector('.loading-content');

        let allBagItems = []; // Variable to cache all bag items

        async function updateBagCount(user) {
            if (user) { // Fungsi ini dibiarkan untuk logika internal, tapi tidak akan update UI navbar
                const bagColRef = collection(db, 'users', user.uid, 'bag');
                const bagSnapshot = await getDocs(bagColRef);

                let validItemsCount = 0;
                const itemsToDelete = [];

                // Create an array of promises to check each item's existence
                const existenceChecks = bagSnapshot.docs.map(async (bagDoc) => {
                    const productId = bagDoc.id;
                    const productRef = doc(db, "products", productId);
                    const productSnap = await getDoc(productRef);

                    if (productSnap.exists()) {
                        return true; // Item is valid
                    } else {
                        itemsToDelete.push(productId); // Mark for deletion
                        return false; // Item is invalid
                    }
                });

                // Wait for all checks to complete
                const results = await Promise.all(existenceChecks);

                // Clean up orphan items in the background
                if (itemsToDelete.length > 0) {
                    console.log('Cleaning up orphan bag items:', itemsToDelete);
                    for (const productId of itemsToDelete) {
                        const bagItemRef = doc(db, 'users', user.uid, 'bag', productId);
                        await deleteDoc(bagItemRef);
                    }
                }
            }
        }

        function formatDate(timestamp) {
            if (!timestamp || !timestamp.toDate) {
                return ''; // Return empty string if timestamp is invalid
            }
            const date = timestamp.toDate();
            const dayNames = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];

            const day = dayNames[date.getDay()];
            const dayOfMonth = date.getDate();
            const month = monthNames[date.getMonth()];
            const year = date.getFullYear();

            return `${day}, ${dayOfMonth} ${month} ${year}`;
        }

        async function initializeBagPage(user) {
            bagLoader.style.display = 'flex'; // Tampilkan loader
            bagItemsContainer.style.display = 'none'; // Sembunyikan kontainer item

            const bagColRef = collection(db, 'users', user.uid, 'bag');
            const bagSnapshot = await getDocs(bagColRef);

            if (bagSnapshot.empty) {
                allBagItems = [];
                renderBagItems(); // Render pesan "tas kosong"
                bagLoader.style.display = 'none'; // Sembunyikan loader
                bagItemsContainer.style.display = 'block'; // Tampilkan kembali kontainer (untuk pesan 'tas kosong')
                mainContent.classList.add('loaded'); // Tampilkan pesan "tas kosong"
                return;
            }

            // Use Promise.all to load all product details concurrently
            const itemPromises = bagSnapshot.docs.map(async (bagDoc) => {
                const bagItem = bagDoc.data();
                const productRef = doc(db, "products", bagItem.productId);
                const productSnap = await getDoc(productRef);

                if (productSnap.exists()) {
                    return { ...bagItem, product: productSnap.data(), id: productSnap.id };
                } else {
                    return null; // Handle case where product might have been deleted
                }
            });

            // Filter out nulls and cache the result
            allBagItems = (await Promise.all(itemPromises)).filter(item => item !== null);

            renderBagItems(); // Initial render
            bagLoader.style.display = 'none'; // Sembunyikan loader
            bagItemsContainer.style.display = 'block'; // Tampilkan kembali kontainer dengan produk di dalamnya
            mainContent.classList.add('loaded'); // Tampilkan konten dengan fade-in
        }

        // Function to render items based on the cached list and a search term
        function renderBagItems() {
            const filteredItems = allBagItems; // Tidak ada lagi fungsi search

            if (filteredItems.length === 0) {
                bagItemsContainer.innerHTML = '<div class="empty-bag-message"><h3>Tas Anda masih kosong.</h3><p>Simpan produk yang Anda suka untuk melihatnya di sini.</p></div>';
                return;
            }

            bagItemsContainer.innerHTML = ''; // Clear current items

            // Sort items by addedAt date, newest first
            filteredItems.sort((a, b) => {
                const dateA = a.addedAt ? a.addedAt.toMillis() : 0;
                const dateB = b.addedAt ? b.addedAt.toMillis() : 0;
                return dateB - dateA; // Newest first
            });

            filteredItems.forEach(item => {
                const product = item.product;
                const formattedDate = formatDate(item.addedAt);
                const dateHTML = formattedDate ? `<p class="bag-item-date" style="font-size: 0.8em; color: var(--gray); margin-bottom: 5px;">Disimpan: ${formattedDate}</p>` : '';

                const itemEl = document.createElement('div');
                itemEl.className = 'bag-item';
                itemEl.innerHTML = `
                    <div class="bag-item-image">
                        <a href="product-detail.html?id=${item.id}">
                            <img src="${product.images && product.images.length > 0 ? product.images[0] : 'https://via.placeholder.com/150'}" alt="${product.name}">
                        </a>
                    </div>
                    <div class="bag-item-info">
                        ${dateHTML}
                        <h3><a href="product-detail.html?id=${item.id}" style="text-decoration:none; color:inherit;">${product.name}</a></h3>
                        <p class="bag-item-price">Rp ${product.price.toLocaleString('id-ID')}</p>
                    </div>
                    <button class="btn-remove-from-bag" data-id="${item.id}">Hapus</button>
                `;
                bagItemsContainer.appendChild(itemEl);
            });

            // Add event listeners to remove buttons
            document.querySelectorAll('.btn-remove-from-bag').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const productIdToRemove = e.target.dataset.id;
                    const user = auth.currentUser;
                    if (!user) return;

                    e.target.disabled = true;
                    e.target.textContent = 'Menghapus...';

                    try {
                        const bagItemRef = doc(db, 'users', user.uid, 'bag', productIdToRemove);
                        await deleteDoc(bagItemRef);
                        // Refetch and re-render after deletion
                        await initializeBagPage(user);
                        updateBagCount(user);
                    } catch (error) {
                        console.error("Error removing from bag: ", error);
                        e.target.disabled = false;
                        e.target.textContent = 'Hapus';
                    }
                });
            });
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                mainContent.classList.remove('loaded'); // Sembunyikan konten dulu
                await initializeBagPage(user); // Fetch data and render
            } else {
                // User is signed out.
                localStorage.removeItem('username');
                allBagItems = [];
                bagLoader.style.display = 'none'; // Pastikan loader tersembunyi
                bagItemsContainer.innerHTML = '<div class="empty-bag-message"><h3>Silakan login untuk melihat tas Anda.</h3><p><a href="login.html" style="color: white; text-decoration: underline;">Login di sini</a></p></div>';
                mainContent.classList.add('loaded'); // Tampilkan pesan login
            }
            await updateBagCount(user);
            // Baris di bawah ini dipindahkan ke dalam blok if/else untuk kontrol yang lebih baik
            // mainContent.classList.add('loaded');
        });

    </script>
</body>

</html>